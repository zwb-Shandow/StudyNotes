# 操作系统架构设计

计算机分层视图，自下而上：硬件 -> 操作系统 -> 应用程序

冯.诺依曼体系架构计算机硬件:
 - 处理器
   - 运算器: 负责算数运算和逻辑运算
   - 控制器: 负责应对所有的信息状况，调度运算器把计算做好
   - 寄存器: 暂存指令、数据和地址
 - 主存
 - 总线: 总线宽度决定了寻址空间，反应系统并行处理能力和资源寻址能力
 - I/O设备
   - 硬盘
   - 键鼠
   - 显示器

操作系统有两个基本功能∶
 - 防止硬件被失控的应用程序滥用；
 - 向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备。操作系统通过几个基本的抽象概念（进程、虚拟内存和文件）来实现这两个功能。

操作系统通过几个抽象概念（进程、虚拟内存和文件）来实现这两个功能。
 - 文件是对 I/O 设备的抽象
 - 虚拟内存是对主存和磁盘 I/O 设备的抽象
 - 进程是对处理器、主存和 I/O 设备的抽象

## 进程与线程

进程间私有和共享的资源：

- 私有：地址空间、程序计数器、堆、栈、数据段
- 共享：代码段、公共数据、进程目录、进程ID

线程间私有和共享的资源：

- 私有：线程栈、寄存器、程序计数器
- 共享：进程堆内存、进程地址空间、全局变量、静态变量

## 虚拟内存
进程的虚拟地址空间的排布:

![](/home/trunk/Documents/personal/StudyNotes/docs/Pic/pic16.png)

### 内核区

内核总是驻留在内存中，是操作系统的一部分。内核空间为内核保留，不允许应用程序读写该区域的内容或直接调用内核代码定义的函数。

### 栈区(Stack)

位于用户虚拟地址空间顶部的是**用户栈**，编译器用它来实现函数调用。和堆一样，用户栈在程序执行期间可以动态地扩展和收缩。特别地，每次我们调用一个函数时，栈就会增长；从一个函数返回时，栈就会收缩。

主要作用：

- 存储函数内部声明的非静态局部变量
- 记录函数调用过程相关的维护性信息，称为栈帧(Stack Frame)或过程活动记录(Procedure Activation Record)。它包括函数返回地址，不适合装入寄存器的函数参数及一些寄存器值的保存。除递归调用外，堆栈并非必需。因为编译时可获知局部变量，参数和返回地址所需空间，并将其分配于BSS段。
- 临时存储区，用于暂存长算术表达式部分计算结果或alloca()函数分配的栈内内存。

### 内存映射段(mmap)

共享库映射

### 堆区(Heap)

堆用于存放进程运行时动态分配的内存段，可动态扩张或缩减。堆中内容是匿名的，不能按名字直接访问，只能通过指针间接访问。当进程调用malloc(C)/new(C++)等函数分配内存时，新分配的内存动态添加到堆上(扩张)；当调用free(C)/delete(C++)等函数释放内存时，被释放的内存从堆中剔除(缩减) 。

分配的堆内存是经过字节对齐的空间，以适合原子操作。堆管理器通过链表管理每个申请的内存，由于堆申请和释放是无序的，最终会产生内存碎片。堆内存一般由应用程序分配释放，回收的内存可供重新使用。若程序员不释放，程序结束时操作系统可能会自动回收。

### BSS 段(Block Started by Symbol)

BSS 段中通常存放程序中以下符号：

- 未初始化的全局变量和静态局部变量
- 初始值为0的全局变量和静态局部变量
- 未定义且初始值不为0的符号

### 数据段

数据段通常用于存放程序中已初始化且初值不为0的全局变量和静态局部变量。数据段属于静态内存分配(静态存储区)，可读可写。

### 代码段

### 保留区

位于虚拟地址空间的最低部分，未赋予物理地址。任何对它的引用都是非法的，用于捕捉使用空指针和小整型值指针引用内存的异常情况

## 文件

文件就是字节序列，仅此而已。系统中所有的输入输出都是通过使用一组成为 Unix I/O 的系统函数调用读写文件来实现的。
文件这个简单而精致的概念是非常强大的，因为它向应用程序提供了一个统一的视图，来看待系统中可能含有的所有各式各样的 I/O 设备。



## 参考链接

[1] [Linux虚拟地址空间布局](https://zhuanlan.zhihu.com/p/378943558)

[2] [Linux操作系统](https://www.cnblogs.com/cxuanBlog/p/13789900.html)
